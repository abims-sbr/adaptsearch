<?xml version="1.0"?>

<tool name="MutCount" id="mutcount" version="2.1.1">
    <description>
        This tool proceeds to count codons, amino acids on each species of a set of species, and then proceeds to permutation tests.
    </description>

    <macros>
        <import>macros.xml</import>
    </macros>

    <requirements>
        <expand macro="python_required" />
        <requirement type="package" version="0.20.0">pandas</requirement>
        <requirement type="package" version="1.12.0">numpy</requirement>
    </requirements>

    <command>
    <![CDATA[
    
        ln -s $__tool_directory__/scripts/functions.py . &&
        
        #if str($method.method_run) == "concat" :            
            python '$__tool_directory__/scripts/S01a_codons_counting.py' ${method.concat_nuc} '$method.list_species' '$method.list_species_boot' $method.num_iter $method.num_sampled > ${log}
        #end if
        
        #if str($method.method_run) == "separated" :
            #set $infiles = ""
            #for $input in $method.sep_file
                ln -s '$input' '$input.element_identifier';
                #set $infiles = $infiles + $input.element_identifier + ","
            #end for
            #set $infiles = $infiles[:-1]

            #if str($method.format_run)== "nucleic" :
                python '$__tool_directory__/scripts/S02b_study_seq_composition_nuc.py' ${method.concat_phy}
            #end if

            #if str($method.format_run)== "proteic" :
                cp '$__tool_directory__/scripts/amino_acid_properties.csv' .
                &&
                python '$__tool_directory__/scripts/S01b_study_seq_composition_aa.py' ${method.concat_phy}
            #end if
        #end if
        
    ]]>
    </command>

    <inputs>
        <conditional name="method">
            <param name="method_run" type="select" label="Which method do you want to use for this tool? ">
                <option value="concat">Concatenated genes in DNA (concatenation from RAxML run)</option>
                <option value="separated">Set of separated genes (from ORF_Search output "output zip containing files with CDS without indel")</option>
            </param>

            <when value="concat">
                <param name="concat_nuc" type="data" format="fasta" label="Choose your fasta file in nucleic format" help="It must contain the concatenated file in NUCLEIC format from Phylogeny tool" />
                <param name="list_species" type="text" size="100" label="List of species for countings" help="List the species separated with a comma (for e.g Ap,As,Ct,Gt,Yu)" />
                <param name="list_species_boot" type="text" size="100" label="List of species used for resampling" help="List the species separated with a comma (for e.g Ap,As,Ct,Gt,Yu)" />
                <param name="num_iter" type="integer" value="1000" min="0" label="Number of sampled codons" help="Sets the length (in codons) of the resampled sequences"/>
                <param name="num_sampled" type="integer" value="1000" min="0" label="Number of iterations" help="Sets the number of resampled sequences"/>
            </when>

            <when value="separated">
                <param name="format_run" type="select" label="Which format do you want to use for this tool (concatenation and RAxML run) ? ">
                    <option value="nucleic">Nucleic format</option>
                    <option value="proteic">Proteic format</option>
                </param>
                <param name="sep_file" type="data" format="fasta" multiple="true" label="Choose fasta files" help="Concatenated files from ORF_search tool ; in nucleic or proteic, according to the format chosen above" />
                <param name="concat_phy" type="data" format="fasta" label="Concatenated file from Phylogeny step" help="This file is used to retrieve the species names" />
            </when>
        </conditional>
    </inputs>

    <outputs>
        <!-- output concat -->
        <data format="txt" name="log" label="MutCount_concat_log.output" >
            <filter>(method['method_run']=='concat')</filter>
        </data>
        <data format="csv" name="codons_freqs" label="codons_freqs.csv" from_work_dir="codons_freqs.csv" >
            <filter>(method['method_run']=='concat')</filter>
        </data>
        <data format="csv" name="aa_freqs" label="aa_freqs.csv" from_work_dir="aa_freqs.csv" >
            <filter>(method['method_run']=='concat')</filter>
        </data>
        <data format="csv" name="aatypes_freqs" label="aatypes_freqs.csv" from_work_dir="aatypes_freqs.csv" >
            <filter>(method['method_run']=='concat')</filter>
        </data>
        <data format="csv" name="gc_and_others_freqs" label="gc_and_others_freqs.csv" from_work_dir="gc_and_others_freqs.csv" >
            <filter>(method['method_run']=='concat')</filter>
        </data>
        <data format="csv" name="codons_transitions_freqs" label="codons_transitions_freqs" from_work_dir="codons_transitions_freqs.csv" >
            <filter>(method['method_run']=='concat')</filter>
        </data>
        <data format="csv" name="aa_transitions_freqs" label="aa_transitions_freqs.csv" from_work_dir="aa_transitions_freqs.csv" >
            <filter>(method['method_run']=='concat')</filter>
        </data>
        <data format="csv" name="aatypes_transitions_freqs" label="aatypes_transitions.csv" from_work_dir="aatypes_transitions_freqs.csv" >
            <filter>(method['method_run']=='concat')</filter>
        </data>

        <!-- outputs separated - nucleic -->
        <data format="csv" name="nuc_comp" label="nuc_compositions.csv" from_work_dir="OUT/nuc_compositions.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'nucleic')</filter>
        </data>
        <data format="csv" name="percent_gc" label="percent_GC.csv" from_work_dir="OUT/percent_GC.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'nucleic')</filter>
        </data>
        <data format="csv" name="percent_pur" label="percent_purine.csv" from_work_dir="OUT/percent_purine.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'nucleic')</filter>
        </data>
        <data format="csv" name="purine_load" label="Purine_Load_Indice.csv" from_work_dir="OUT/Purine_Load_Indice.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'nucleic')</filter>
        </data>

        <!-- outputs separated - proteic -->
        <data format="csv" name="prot_comp" label="prot_compositions_All_AA.csv" from_work_dir="OUT/prot_compositions_All_AA.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="ivywrel" label="IVYWREL.csv" from_work_dir="OUT/IVYWREL.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="erk_dnqtsh" label="ERK_DNQTSH.csv" from_work_dir="OUT/ERK_DNQTSH.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="ek_qh" label="EK_QH.csv" from_work_dir="OUT/EK_QH.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="fymink_garp" label="FYMINK_GARP.csv" from_work_dir="OUT/FYMINK_GARP.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="avlimfyw" label="AVLIMFYW.csv" from_work_dir="OUT/AVLIMFYW.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="stnq" label="STNQ.csv" from_work_dir="OUT/STNQ.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="rhkde" label="RHKDE.csv" from_work_dir="OUT/RHKDE.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="payre_mvgds" label="PAYRE-MVGDS.csv" from_work_dir="OUT/PAYRE-MVGDS.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="res_weigth" label="TotalResidueWeight.csv" from_work_dir="OUT/TotalResidueWeight.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="res_vol" label="TotalResidueVolume.csv" from_work_dir="OUT/TotalResidueVolume.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="spec_vol" label="TotalPartialSpecificVolume.csv" from_work_dir="OUT/TotalPartialSpecificVolume.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="hydrat" label="TotalHydratation.csv" from_work_dir="OUT/TotalHydratation.csv" >
            <filter>(method['method_run']=='separated' and method['format_run']== 'proteic')</filter>
        </data>
        
    </outputs>

    <tests>
        <test>
            <conditional name="method" >
                <param name="method_run" value="concat" />
                <param name="concat_nuc" ftype="fasta" value="concatenation.fasta" />
                <param name="list_species" ftype="text" value="Ps,Pp,Pu,Ac,Ap,Pf,Pg,Ph,Pi" />
                <param name="list_species_boot" ftype="text" value="Ps,Pp,Pu,Pf" />
                <param name="num_iter" value="200" />
                <param name="num_sampled" value="200" /> 
            </conditional>
            <output name="log" value="OUT_concat/MutCount_concat_log.output" lines_diff="2"/>
            <output name="codons_freqs" value="OUT_concat/codons_freqs.csv" lines_diff="18"/>
            <output name="aa_freqs" value="OUT_concat/aa_freqs.csv" lines_diff="18"/>
            <output name="aatypes_freqs" value="OUT_concat/aatypes_freqs.csv" lines_diff="18"/>
            <output name="gc_and_others_freqs" value="OUT_concat/gc_and_others_freqs.csv"/>            
            <output name="codons_transitions_freqs" value="OUT_concat/codons_transitions_freqs.csv" lines_diff="72"/>
            <output name="aa_transitions_freqs" value="OUT_concat/aa_transitions_freqs.csv" lines_diff="72"/>
            <output name="aatypes_transitions_freqs" value="OUT_concat/aatypes_transitions_freqs.csv" lines_diff="72"/>
        </test>
        <!--
        <test>
            <conditional name="method" >
                <param name="method_run" value="separated" />
                <param name="format_run" value="nucleic" />
                <param name="sep_file" ftype="fasta" value="sep_nuc/locus1_sp6_sp6.fasta,sep_nuc/locus1_sp8_sp8.fasta,sep_nuc/locus2_sp6_sp6.fasta" />
                <param name="concat_phy" ftype="fasta" value="phylogeny_concat.fasta" />
            </conditional>
            <output name="nuc_comp">
                <assert_contents>
                    <has_line line="locus2_sp6_sp6.fasta,0.30208,0.23958,0.19792,0.26042,0.29688,0.27604,0.18229,0.24479,NA,NA,NA,NA,0.30208,0.24479,0.19792,0.25521,NA,NA,NA,NA,0.31250,0.26042,0.17188,0.25521,0.32292,0.21875,0.20312,0.25521,NA,NA,NA,NA,NA,NA,NA,NA,0.31771,0.25521,0.17708,0.25000"/>
                </assert_contents>
            </output>
            <output name="percent_gc">
                <assert_contents>
                    <has_line line="locus2_sp6_sp6.fasta,45.83333,42.70833,NA,45.31250,NA,42.70833,45.83333,NA,NA,42.70833" />
                </assert_contents>
            </output>
            <output name="percent_pur">
                <assert_contents>
                    <has_line line="locus2_sp6_sp6.fasta,56.25000,54.16667,NA,55.72917,NA,56.77083,57.81250,NA,NA,56.77083" />
                </assert_contents>
            </output>
            <output name="purine_load">
                <assert_contents>
                    <has_line line="locus2_sp6_sp6.fasta,192,12,12,62.50000,62.50000,192,12,4,62.50000,20.83333,NA,NA,NA,NA,NA,192,11,11,57.29167,57.29167,NA,NA,NA,NA,NA,192,16,10,83.33333,52.08333,192,10,20,52.08333,104.16667,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,192,14,12,72.91667,62.50000" />
                </assert_contents>
            </output>
        </test>
        
        <test>
            <conditional name="method" >
                <param name="method_run" value="separated" />
                <param name="format_run" value="proteic" />
                <param name="sep_file" ftype="fasta" value="sep_aa/locus1_sp6_sp6.fasta,sep_aa/locus1_sp8_sp8.fasta,sep_aa/locus2_sp6_sp6.fasta" />
                <param name="concat_phy" ftype="fasta" value="phylogeny_concat.fasta" />
            </conditional>            
            <output name="ivywrel">
                <assert_contents>
                    <has_line line="locus1_sp8_sp8.fasta,25.00000,0.36765,28.00000,0.36364,NA,NA,NA,NA,27.00000,0.35065,27.00000,0.35065,28.00000,0.36364,0.00000,0.00000,27.00000,0.40909,27.00000,0.35065" />
                </assert_contents>
            </output>
            <output name="rhkde">
                <assert_contents>
                    <has_line line="locus1_sp6_sp6.fasta,28.00000,0.35897,14.00000,0.17949,14.00000,0.17949,30.00000,0.38462,16.00000,0.20513,14.00000,0.17949,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,30.00000,0.38462,16.00000,0.20513,14.00000,0.17949,30.00000,0.38462,16.00000,0.20513,14.00000,0.17949,30.00000,0.38462,16.00000,0.20513,14.00000,0.17949,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,30.00000,0.38462,16.00000,0.20513,14.00000,0.17949"/>
                </assert_contents>
            </output>
            <output name="payre_mvgds">
                <assert_contents>
                    <has_line line="locus1_sp8_sp8.fasta,16.00000,0.23529,3.00000,0.04412,27.00000,0.39706,0.59259,0.11111,18.00000,0.23377,4.00000,0.05195,29.00000,0.37662,0.62069,0.13793,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,19.00000,0.24675,6.00000,0.07792,30.00000,0.38961,0.63333,0.20000,20.00000,0.25974,7.00000,0.09091,32.00000,0.41558,0.62500,0.21875,20.00000,0.25974,5.00000,0.06494,29.00000,0.37662,0.68966,0.17241,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,14.00000,0.21212,2.00000,0.03030,26.00000,0.39394,0.53846,0.07692,19.00000,0.24675,6.00000,0.07792,32.00000,0.41558,0.59375,0.18750"/>
                </assert_contents>
            </output>
            <output name="avlimfyw">
                <assert_contents>
                    <has_line line="locus2_sp6_sp6.fasta,27.00000,0.42188,21.00000,0.32812,6.00000,0.09375,28.00000,0.43750,22.00000,0.34375,6.00000,0.09375,NA,NA,NA,NA,NA,NA,28.00000,0.43750,22.00000,0.34375,6.00000,0.09375,NA,NA,NA,NA,NA,NA,28.00000,0.43750,22.00000,0.34375,6.00000,0.09375,30.00000,0.46875,24.00000,0.37500,6.00000,0.09375,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,28.00000,0.43750,22.00000,0.34375,6.00000,0.09375"/>
                </assert_contents>
            </output>           
        </test>
    -->
    </tests>

    <help>

@HELP_AUTHORS@

<![CDATA[

**Last Version** : Victor Mataigne and Gildas Le CorguillÃ©

--------

**Description**

This script counts the number of codons, amino acids, and types of amino acids in sequences, as well as the mutation bias from one item to another between 2 sequences. Counting is then compared to empirical p-values, obtained from bootstrapped sequences obtained from a subset of sequences.
    
In the output files, the pvalues indicate the position of the observed data in a distribution of empirical countings obtained from a resample of the data. Values above 0.95 indicate a significantly higher counting, values under 0.05 a significantly lower counting.

The script resamples random pairs of aligned codon to determine what countings can be expected under the hypothesis of an homogenous dataset.
Countings are performed on each generated random alignement, thousands of alignments allow to draw a gaussian distribution of the countings.
Then the script simply checks whether the observed data are within the 5% lowest or 5% highest values of the distribution.

--------

.. class:: infomark

**Input files**

If you choose the concatenated method, the input file is the concatenated genes fasta file (in nucleic format) from a previous run of the toolConcatPhyl.

If you choose the separated method, there are two input files :
- A dataset collection containing output files from the CDS_Search tool, the one without indels. These files must be in nucleic or proteic format according to the format chosen along with the method.
- The concatenated genes fasta file from ConcatPhyl, only used here to retrieve species name.

--------

**Parameters**

There are parameters only for the "Concatenated" method :

- The list of species for **countings**, separated by commas and without space (e.g : sp1,sp2,sp3,sp4). You can run the tool on subgroup of species, not only on the total number of species present in the previous tools.

- The list of species for **resampling**, separated by commas and without space (e.g : sp1,sp2,sp3,sp4). You can run the tool on subgroup of species, not only on the total number of species present in the previous tools. 

- The number of iterations : the number of alignments that will be generated (effect on the resolution of the gaussian distribution). Shouldn't be lower than 1000 to have a relatively smooth gaussian distribution.

- The number of sampled codons : the number of pairs of codons in each generated alignments (effect on the robustness on the countings performed on this alignement). Shouldn't be lower than 1000 to detect codons with relatively low occurence (<1%).

--------

**Outputs**

Many outputs in .csv format , varying according to the chosen method and format (separated, nucleic ...)
    - When method = concat : 6 .csv outputs : countings of codons, amino acids, amino acids types, and transitions from amino acid to amino acid and from amino acid type to amino acid type.
    - When method = separated and format = nucleic : 4 .csv outputs : nucleotide composition, GC percent, purine percent, purine load indice.
    - When method = separated and format = proteic : 13 .csv outputs : protein composition, several files of countings various AA combinations, results on residues, hydratation, partial specific volume.

---------

**The AdaptSearch Pipeline**

.. image:: adaptsearch_picture_helps.png

---------

Changelog
---------

**Version 2.1 - 26/02/2017**
- Fully re-written the concat method : fixed mistakes + cleaner code
- Splitted output of concatenated method in several csv files.
- Bug corrected in output files of separated method.

**Version 2.0 - 12/07/2017**

- NEW: Replaced the zip between tools by Dataset Collection
- More functional tests

**Version 1.0 - 14/04/2017**
   
- Added the tools to the suite
- Added a functional test with planemo
- Planemo test using conda dependencies for python
- Scripts renamed + symlinks to the directory 'scripts'

    ]]>

    </help>
    
    <expand macro="citations" />

</tool>
